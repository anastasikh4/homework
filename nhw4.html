<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New Year Grammar Quest</title>
    <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body { 
            background-color: #003049; 
            background-image: radial-gradient(#ffffff 1px, transparent 1px);
            background-size: 50px 50px;
            font-family: 'Raleway', sans-serif; 
            display: flex; flex-direction: column; align-items: center; padding: 20px; color: #ffffff; 
            overflow-x: hidden;
        }
        .track { width: 100%; max-width: 500px; height: 40px; background: rgba(255,255,255,0.1); border-radius: 20px; position: relative; margin-bottom: 20px; border: 2px solid #669bbc; }
        #sleigh { position: absolute; left: 0%; font-size: 30px; transition: 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275); top: -5px; }

        .game-box { 
            background: rgba(255, 255, 255, 0.98); 
            width: 100%; max-width: 500px; padding: 30px; 
            border-radius: 30px; box-shadow: 0 15px 50px rgba(0,0,0,0.5); 
            text-align: center; border: 6px solid #d62828; color: #003049;
            position: relative; min-height: 420px;
        }
        .step-indicator { font-weight: bold; color: #669bbc; margin-bottom: 10px; text-transform: uppercase; font-size: 14px; }
        
        .scramble-pool { display: flex; gap: 10px; justify-content: center; margin: 20px 0; min-height: 50px; flex-wrap: wrap; }
        .word-pill { background: #669bbc; color: white; padding: 12px 18px; border-radius: 12px; cursor: pointer; font-weight: 900; box-shadow: 0 4px 0 #003049; }
        
        .answer-zone { display: flex; gap: 10px; justify-content: center; margin: 20px 0; border-bottom: 3px dashed #d62828; min-height: 60px; padding-bottom: 10px; flex-wrap: wrap; }
        .answer-word { background: #fdf0d5; padding: 10px 15px; border-radius: 12px; font-weight: 900; color: #003049; border: 2px solid #d62828; cursor: pointer; animation: pop 0.3s; }

        @keyframes pop { 0% { transform: scale(0.8); } 100% { transform: scale(1); } }

        .visual-cue { font-size: 70px; margin: 20px 0; display: flex; justify-content: center; align-items: center; gap: 10px; }
        
        #present-overlay {
            display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.98); border-radius: 25px;
            flex-direction: column; justify-content: center; align-items: center; z-index: 10;
        }
        .present-icon { font-size: 100px; animation: bounce 0.5s infinite alternate; }
        @keyframes bounce { from { transform: translateY(0); } to { transform: translateY(-20px); } }

        .mc-option { background: #fff; border: 2px solid #669bbc; padding: 15px; border-radius: 15px; margin-bottom: 10px; cursor: pointer; font-weight: bold; width: 100%; font-family: 'Raleway'; font-size: 18px; }
        .wrong-ans { background: #fee2e2; border-color: #ef4444; color: #ef4444; }
        
        .start-btn { background: #d62828; color: white; border: none; padding: 20px 40px; border-radius: 15px; font-weight: 900; font-size: 20px; cursor: pointer; }
    </style>
</head>
<body>

<div class="track"><div id="sleigh">üõ∑</div></div>

<div class="game-box" id="game-box">
    <div id="present-overlay">
        <div class="present-icon">üéÅ</div>
        <h2 style="color: #d62828;">CORRECT!</h2>
    </div>

    <div id="content">
        <h1 style="color:#d62828">New Year Mission</h1>
        <p>Are you ready for your presents?</p>
        <button class="start-btn" onclick="startGame()">START üöÄ</button>
    </div>
</div>

<script>
    let currentStep = 1;
    let qIdx = 0;
    const content = document.getElementById('content');
    const overlay = document.getElementById('present-overlay');
    const sleigh = document.getElementById('sleigh');

    const ex1Data = [
        { eng: ["I", "am", "not"] },
        { eng: ["You", "are", "not"] },
        { eng: ["He", "is", "not"] },
        { eng: ["She", "is", "not"] },
        { eng: ["It", "is", "not"] },
        { eng: ["We", "are", "not"] },
        { eng: ["They", "are", "not"] },
        { eng: ["He", "is", "happy"] },
        { eng: ["I", "am", "cool"] },
        { eng: ["She", "is", "fast"] }
    ];

    const ex2Data = [
        { eng: ["She", "is", "not"], cue: "üëß", symbol: "‚ùå" },
        { eng: ["He", "is"], cue: "üë¶", symbol: "‚úÖ" },
        { eng: ["They", "are", "not"], cue: "üë®‚Äçüë©‚Äçüëß", symbol: "‚ùå" }
    ];

    const ex3Data = [
        { cue: "üëß", symbol: "‚ùå", ans: "She is not", options: ["She is not", "He is not", "They are not"] },
        { cue: "üë¶", symbol: "‚úÖ", ans: "He is", options: ["They are", "He is", "She is"] },
        { cue: "üë®‚Äçüë©‚Äçüëß", symbol: "‚ùå", ans: "They are not", options: ["I am not", "He is not", "They are not"] },
        { cue: "üê∂", symbol: "‚úÖ", ans: "It is", options: ["It is", "She is", "They are"] },
        { cue: "üë¶", symbol: "‚ùå", ans: "He is not", options: ["She is not", "They are not", "He is not"] },
        { cue: "üëß", symbol: "‚úÖ", ans: "She is", options: ["He is", "She is", "It is"] }
    ];

    function startGame() { loadQuestion(); }

    function playSuccessSound() {
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();
        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);
        oscillator.type = 'sine';
        oscillator.frequency.setValueAtTime(523.25, audioCtx.currentTime); 
        oscillator.frequency.exponentialRampToValueAtTime(1046.50, audioCtx.currentTime + 0.1); 
        gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
        oscillator.start();
        oscillator.stop(audioCtx.currentTime + 0.3);
    }

    function speak(t) {
        window.speechSynthesis.cancel();
        const utterance = new SpeechSynthesisUtterance(t);
        const voices = window.speechSynthesis.getVoices();
        const maleVoice = voices.find(v => v.name.includes('Microsoft David')) || 
                          voices.find(v => v.name.includes('David')) ||
                          voices.find(v => v.lang.startsWith('en'));
        if (maleVoice) utterance.voice = maleVoice;
        utterance.rate = 0.85;
        window.speechSynthesis.speak(utterance);
    }

    function updateSleigh() {
        let total = ex1Data.length + ex2Data.length + ex3Data.length;
        let current = (currentStep === 1 ? qIdx : currentStep === 2 ? ex1Data.length + qIdx : ex1Data.length + ex2Data.length + qIdx);
        sleigh.style.left = (current / total * 90) + "%";
    }

    function loadQuestion() {
        content.innerHTML = "";
        overlay.style.display = "none";
        updateSleigh();

        if (currentStep === 1) {
            let sentence = ex1Data[qIdx].eng.join(' ');
            content.innerHTML = `
                <div class="step-indicator">‚ùÑÔ∏è Mission 1: Listen (${qIdx + 1}/10)</div>
                <button onclick="speak('${sentence}')" style="font-size:70px; border:none; background:none; cursor:pointer;">üîä</button>
                <div class="answer-zone" id="answer-zone"></div>
                <div class="scramble-pool" id="pool"></div>
            `;
            renderWords(ex1Data[qIdx].eng);
            // ONLY Exercise 1 is voiced
            setTimeout(() => speak(sentence), 400);
        } else if (currentStep === 2) {
            const q = ex2Data[qIdx];
            content.innerHTML = `
                <div class="step-indicator">üéÑ Mission 2: Emojis (${qIdx + 1}/3)</div>
                <div class="visual-cue">${q.cue} <span style="color:${q.symbol==='‚úÖ'?'#22c55e':'#ef4444'}">${q.symbol}</span></div>
                <div class="answer-zone" id="answer-zone"></div>
                <div class="scramble-pool" id="pool"></div>
            `;
            renderWords(q.eng);
        } else if (currentStep === 3) {
            const q = ex3Data[qIdx];
            content.innerHTML = `
                <div class="step-indicator">üéÖ Mission 3: Choose (${qIdx + 1}/6)</div>
                <div class="visual-cue">${q.cue} <span style="color:${q.symbol==='‚úÖ'?'#22c55e':'#ef4444'}">${q.symbol}</span></div>
                <div id="options-box"></div>
            `;
            q.options.forEach(opt => {
                const b = document.createElement('button');
                b.className = 'mc-option';
                b.innerText = opt;
                b.onclick = () => { if(opt === q.ans) showPresent(); else b.classList.add('wrong-ans'); };
                document.getElementById('options-box').appendChild(b);
            });
        }
    }

    function renderWords(words) {
        const pool = document.getElementById('pool');
        [...words].sort(() => Math.random() - 0.5).forEach(w => {
            const b = document.createElement('div');
            b.className = 'word-pill';
            b.innerText = w;
            b.onclick = () => {
                const zone = document.getElementById('answer-zone');
                const az = document.createElement('div');
                az.className = 'answer-word';
                az.innerText = w;
                az.onclick = () => { az.remove(); b.style.display = "block"; };
                zone.appendChild(az);
                b.style.display = "none";
                
                if(zone.children.length === words.length) {
                    const user = Array.from(zone.children).map(c => c.innerText).join(' ');
                    if(user === words.join(' ')) showPresent();
                    else { zone.style.borderColor = "red"; setTimeout(() => zone.style.borderColor = "#d62828", 500); }
                }
            };
            pool.appendChild(b);
        });
    }

    function showPresent() {
        playSuccessSound();
        overlay.style.display = "flex";
        setTimeout(nextQuest, 1200);
    }

    function nextQuest() {
        qIdx++;
        let max = (currentStep === 1) ? ex1Data.length : (currentStep === 2) ? ex2Data.length : ex3Data.length;
        if (qIdx >= max) { currentStep++; qIdx = 0; }

        if (currentStep > 3) {
            sleigh.style.left = "90%";
            content.innerHTML = "<h1>üéÑ HAPPY NEW YEAR!</h1><p>You are a Grammar Master!</p><div style='font-size:60px'>üéÖüéÅ‚õÑ</div>";
            overlay.style.display = "none";
        } else {
            loadQuestion();
        }
    }
    
    // Voice initialization
    window.speechSynthesis.onvoiceschanged = () => {};
</script>
</body>
</html>
